dist: xenial
language: node_js
cache: npm
branches:
    only:
        - master
env:
    global:
        # List of all touched files, excluding paths starting with 'packages'
        - CHANGED_GLOBAL_FILES=$(git diff --name-only $TRAVIS_COMMIT_RANGE | grep -v "^packages")
        # Build only touched packages for pull requests when no shared files were touched
        - PARTIAL_BUILD=$(if [ "$CHANGED_GLOBAL_FILES" == "" ] && [ "$TRAVIS_PULL_REQUEST" != "false" ]; then echo "true"; else echo "false"; fi)
        # Set arguments so lerna only runs scripts in changed packages
        - SCRIPT_ARGS=$(if [ "$PARTIAL_BUILD" = "true" ]; then echo "--since $TRAVIS_BRANCH"; else echo ""; fi)
before_script:
    - echo $TRAVIS_COMMIT_RANGE
    - echo $CHANGED_GLOBAL_FILES
    - echo $PARTIAL_BUILD
    - echo $SCRIPT_ARGS

matrix:
    include:
        - name: "Lint, Build & Unit tests"
          script:
              - npm run lint -- $SCRIPT_ARGS
              - npm run build -- $SCRIPT_ARGS
              - npm run test -- $SCRIPT_ARGS
        - name: "Automated Tests"
          addons:
              chrome: stable
          before_install:
              - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
          script:
              - travis_wait 30 npm run test:e2e -- $SCRIPT_ARGS
        - name: "IE11 Automated Tests"
          os: windows
          script:
              - travis_wait 30 npm run test:e2e:ie11 -- $SCRIPT_ARGS
        - name: "iOS Automated tests"
          language: objective-c
          os: osx
          osx_image: xcode11.2
          env:
              - REACT_NATIVE_VERSION=0.59.9
              - PATH=$PATH:~/Library/Python/2.7/bin
              - CODE_SIGNING_REQUIRED=NO
          install:
              - npm install -g detox-cli
              - gem install xcpretty
              - brew tap wix/brew
              - brew install applesimutils --HEAD
              - npm install
          script:
              - node -v
              - npm -v
              - npm run test:e2e:native -- $SCRIPT_ARGS
        - name: "Android Automated tests"
          language: android
          env:
              - REACT_NATIVE_VERSION=0.59.9
          before_install:
              - sudo apt-get install npm
          install:
              - npm install -g detox-cli
              - gem install xcpretty
              - npm install
          android:
              components:
                  - tools
                  - platform-tools
                  - build-tools-27.0.3
                  - android-26
                  - extra-google-google_play_services
                  - extra-google-m2repository
                  - extra-android-m2repository
                  - sys-img-x86-android-26
                  - sys-img-x86-android-28
          script:
              - node -v
              - npm -v
              - npm run test:e2e:native -- $SCRIPT_ARGS
notifications:
    email:
        enabled: true
        recipients:
            - diego.antonelli@mendix.com
            - mehmet.izci@mendix.com
            - andries.smit@mendix.com
            - isa.isaku@mendix.com
            - olga.shprygova@mendix.com
        on_success: always
        on_failure: always
        on_error: always
    slack:
        enabled: true
        template:
            - "Build <%{build_url}|#%{build_number}> of %{repository_slug}@%{branch} in PR <%{pull_request_url}|#%{pull_request_number}> by %{author} %{result} in %{duration}"
        rooms:
            - mendix:$SLACK_KEY#widget-team-private
        on_success: always
        on_failure: always
        on_error: always
        on_pull_requests: true
